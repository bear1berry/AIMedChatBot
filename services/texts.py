from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime
from typing import Optional

from bot.config import (
    FREE_DAILY_LIMIT,
    FREE_MONTHLY_LIMIT,
    PREMIUM_DAILY_LIMIT,
    PREMIUM_MONTHLY_LIMIT,
    REF_BASE_URL,
)


@dataclass
class PlanInfo:
    code: str
    title: str
    daily_limit: int
    monthly_limit: int


FREE_PLAN = PlanInfo(
    code="basic",
    title="–ë–∞–∑–æ–≤—ã–π",
    daily_limit=FREE_DAILY_LIMIT,
    monthly_limit=FREE_MONTHLY_LIMIT,
)

PREMIUM_PLAN = PlanInfo(
    code="premium",
    title="Premium",
    daily_limit=PREMIUM_DAILY_LIMIT,
    monthly_limit=PREMIUM_MONTHLY_LIMIT,
)


def _fmt_date(ts: Optional[float]) -> str:
    if not ts:
        return "‚Äî"
    dt = datetime.fromtimestamp(ts)
    return dt.strftime("%d.%m.%Y")


def render_onboarding(
    first_name: Optional[str],
    is_new: bool,
    plan_title: str,
    mode_title: str,
) -> str:
    name = first_name or "–¥—Ä—É–≥"

    status_line = (
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä—å BlackBox GPT."
        if is_new
        else "–†–∞–¥ —Å–Ω–æ–≤–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å –≤–Ω—É—Ç—Ä–∏ BlackBox GPT."
    )

    return (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {name}.\n\n"
        f"{status_line}\n\n"
        f"üß† –†–µ–∂–∏–º —Å–µ–π—á–∞—Å: *{mode_title}*\n"
        f"üíé –¢–∞—Ä–∏—Ñ: *{plan_title}*\n\n"
        "–ù–∞–ø–∏—à–∏ –º–Ω–µ –ª—é–±–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–æ—Å—Ç–∞ –∏–ª–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞.\n\n"
        "–Ø –æ—Ç–≤–µ—á–∞—é –∞–∫–∫—É—Ä–∞—Ç–Ω–æ: –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞, —Å —á–∏—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ —Ç–≤–æ–µ–º—É –≤—Ä–µ–º–µ–Ω–∏."
    )


def render_profile(
    plan_code: str,
    mode_title: str,
    premium_until: Optional[float],
) -> str:
    plan = PREMIUM_PLAN if plan_code == "premium" else FREE_PLAN

    limits_line = (
        f"–õ–∏–º–∏—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: *{plan.daily_limit}* –∑–∞–ø—Ä–æ—Å–æ–≤.\n"
        f"–õ–∏–º–∏—Ç—ã –Ω–∞ –º–µ—Å—è—Ü: *{plan.monthly_limit}* –∑–∞–ø—Ä–æ—Å–æ–≤."
    )

    premium_line = (
        f"–ü–æ–¥–ø–∏—Å–∫–∞ *Premium* –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ: *{_fmt_date(premium_until)}*."
        if plan_code == "premium"
        else "–°–µ–π—á–∞—Å —É —Ç–µ–±—è –±–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø. –í –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –º–æ–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª."
    )

    return (
        "üë§ *–ü—Ä–æ—Ñ–∏–ª—å*\n\n"
        f"–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: *{mode_title}*\n"
        f"–¢–∞—Ä–∏—Ñ: *{plan.title}*\n\n"
        f"{limits_line}\n\n"
        f"{premium_line}"
    )


def render_modes_root() -> str:
    """
    –¢–µ–∫—Å—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–æ–≤.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ on_modes_root –≤ bot/main.py.
    """
    return (
        "üß† *–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã*\n\n"
        "–ó–¥–µ—Å—å —Ç—ã –≤—ã–±–∏—Ä–∞–µ—à—å, –∫–∞–∫ —è –±—É–¥—É –¥—É–º–∞—Ç—å –∏ –æ—Ç–≤–µ—á–∞—Ç—å:\n\n"
        "‚Ä¢ üß† *–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç* ‚Äî –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å: –æ—Ç –±—ã—Ç–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è –¥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∫—Ä–µ–∞—Ç–∏–≤–∞.\n"
        "‚Ä¢ ü©∫ *–ú–µ–¥–∏—Ü–∏–Ω–∞* ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–º –º—ã—à–ª–µ–Ω–∏–∏ –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –±–∞–∑–µ.\n"
        "‚Ä¢ üî• *–ù–∞—Å—Ç–∞–≤–Ω–∏–∫* ‚Äî —É–ø–æ—Ä –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É.\n"
        "‚Ä¢ üíº *–ë–∏–∑–Ω–µ—Å* ‚Äî –ø—Ä–æ –¥–µ–Ω—å–≥–∏, —Å–∏—Å—Ç–µ–º—ã, –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ —Ä–æ—Å—Ç.\n"
        "‚Ä¢ üé® *–ö—Ä–µ–∞—Ç–∏–≤* ‚Äî –∏–¥–µ–∏, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –∫–æ–Ω—Ü–µ–ø—Ç—ã –∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ö–æ–¥—ã.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω—É–∂–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤–Ω–∏–∑—É ‚Äî —è –ø–µ—Ä–µ–∫–ª—é—á—É—Å—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ."
    )


def render_mode_switched(mode_title: str) -> str:
    return (
        "üß† *–†–µ–∂–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω*\n\n"
        f"–¢–µ–ø–µ—Ä—å —è —Ä–∞–±–æ—Ç–∞—é –∫–∞–∫: *{mode_title}*.\n\n"
        "–ú–æ–∂–µ—à—å —Å—Ä–∞–∑—É –ø—Ä–∏—Å–ª–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî —è —É—á—Ç—É —ç—Ç–æ –≤ —Å—Ç–∏–ª–µ –º—ã—à–ª–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∞—Ö."
    )


def render_subscription_overview(
    plan_title: str,
    premium_until: Optional[float],
) -> str:
    current_line = (
        f"–¢–≤–æ–π —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: *{plan_title}*.\n"
        f"Premium –∞–∫—Ç–∏–≤–µ–Ω –¥–æ: *{_fmt_date(premium_until)}*."
        if plan_title == PREMIUM_PLAN.title
        else "–¢–≤–æ–π —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: *–ë–∞–∑–æ–≤—ã–π*."
    )

    limits_desc = (
        "‚Ä¢ *–ë–∞–∑–æ–≤—ã–π* ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞ –¥–µ–Ω—å –∏ –º–µ—Å—è—Ü.\n"
        "‚Ä¢ *Premium* ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –æ—Ç–∫–ª–∏–∫.\n"
    )

    tail = (
        "–í—ã–±–µ—Ä–∏ —Å—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–Ω–∏–∑—É ‚Äî —è –æ—Ç–∫—Ä–æ—é –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã –≤ CryptoBot (USDT).\n"
        "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏—Å—å –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª."
    )

    return (
        "üíé *–ü–æ–¥–ø–∏—Å–∫–∞ BlackBox GPT*\n\n"
        "–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –¥–≤–∞ —É—Ä–æ–≤–Ω—è:\n"
        f"{limits_desc}\n"
        f"{current_line}\n\n"
        f"{tail}"
    )


def render_payment_link(
    tariff_title: str,
    amount: float,
    invoice_url: str,
) -> str:
    return (
        "‚úÖ *–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω*\n\n"
        f"–¢–∞—Ä–∏—Ñ: *{tariff_title}*.\n"
        f"–°—É–º–º–∞: *{amount:.2f} USDT*.\n\n"
        "–ü–µ—Ä–µ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ CryptoBot:\n"
        f"{invoice_url}\n\n"
        "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Å—å –≤ –±–æ—Ç –∏ –Ω–∞–∂–º–∏ "
        "üíé *–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É* –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª."
    )


def render_payment_error() -> str:
    return (
        "‚ùå *–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂*\n\n"
        "–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.\n"
        "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
    )


def render_payment_check_result(status: str) -> str:
    if status == "paid":
        return (
            "‚úÖ *–û–ø–ª–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞*\n\n"
            "–ü–æ–¥–ø–∏—Å–∫–∞ *Premium* –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.\n"
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ. –¢–µ–ø–µ—Ä—å –ª–∏–º–∏—Ç—ã —Ä–∞—Å—à–∏—Ä–µ–Ω—ã, –∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–º –º–æ—â–Ω–æ—Å—Ç—è–º –ø–æ–≤—ã—à–µ–Ω."
        )

    if status == "pending":
        return (
            "‚åõ *–ü–ª–∞—Ç—ë–∂ –µ—â—ë –≤ –æ–∂–∏–¥–∞–Ω–∏–∏*\n\n"
            "–ü–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É –º–∏–Ω—É—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª –µ—â—ë —Ä–∞–∑.\n"
            "–ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –∑–∞–≤–∏—Å ‚Äî –ø—Ä–æ–≤–µ—Ä—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤ CryptoBot."
        )

    return (
        "‚ö†Ô∏è *–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω*\n\n"
        "–Ø –Ω–µ –≤–∏–∂—É —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ —ç—Ç–æ–º—É —Å—á—ë—Ç—É.\n"
        "–ï—Å–ª–∏ —Ç—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –∏—Å—Ç–æ—Ä–∏—é –≤ CryptoBot –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –Ω–∞–ø–∏—à–∏ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
    )


def render_referrals(ref_code: str, total_refs: int) -> str:
    ref_link = f"{REF_BASE_URL}?start=ref_{ref_code}"

    return (
        "ü§ù *–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞*\n\n"
        "–ü–æ–¥–µ–ª–∏—Å—å –±–æ—Ç–æ–º —Å —Ç–µ–º–∏, –∫–æ–º—É –æ–Ω —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω. "
        "–ù–∏–∫–∞–∫–æ–≥–æ —Å–ø–∞–º–∞ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.\n\n"
        f"üîó –¢–≤–æ—è —Å—Å—ã–ª–∫–∞:\n{ref_link}\n\n"
        f"–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: *{total_refs}* —á–µ–ª–æ–≤–µ–∫(–∞).\n\n"
        "–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É —Ç–µ–º, –∫–æ–º—É —Ö–æ—á–µ—à—å –ø—Ä–æ–∫–∞—á–∞—Ç—å –º–æ–∑–≥ –∏ —Å–∏—Å—Ç–µ–º—É.\n\n"
        "–í–æ–∑–≤—Ä–∞—â–∞—é –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω."
    )


def render_generic_error() -> str:
    return (
        "‚ùå *–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫*\n\n"
        "–Ø —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.\n"
        "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
    )


def render_empty_prompt_error() -> str:
    return (
        "üìù –ó–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π.\n\n"
        "–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ —Ç–µ–±—è –≤–æ–ª–Ω—É–µ—Ç –∏–ª–∏ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.\n"
        "–ú–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é, –ø–æ–º–æ—á—å —Å —Ä–µ—à–µ–Ω–∏–µ–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª–∏ –∏–ª–∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç."
    )


def render_too_long_prompt_error() -> str:
    return (
        "üìè –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∏–ª—Å—è —Å–ª–∏—à–∫–æ–º –æ–±—ä—ë–º–Ω—ã–º.\n\n"
        "–°–æ–∫—Ä–∞—Ç–∏ –µ–≥–æ –∏–ª–∏ —Ä–∞–∑–±–µ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π.\n"
        "–¢–∞–∫ —è —Å–º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ—á–Ω–µ–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ."
    )


def render_limits_warning(reason: str) -> str:
    return (
        "‚ö†Ô∏è *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é*\n\n"
        f"{reason}\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ.\n"
        "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ‚Äî –ø–æ–¥–∫–ª—é—á–∏ —Ç–∞—Ä–∏—Ñ *Premium* –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª."
    )
