from __future__ import annotations

from datetime import datetime
from typing import Optional

from bot.config import (
    FREE_DAILY_LIMIT,
    FREE_MONTHLY_LIMIT,
    PREMIUM_DAILY_LIMIT,
    PREMIUM_MONTHLY_LIMIT,
)


def _fmt_date(dt: Optional[datetime]) -> str:
    if not dt:
        return "‚Äî"
    return dt.strftime("%d.%m.%Y")


def _humanize_int(value: int) -> str:
    # –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥: 12345 -> 12 345
    return f"{value:,}".replace(",", " ")


# =========================
#  –û–Ω–±–æ—Ä–¥–∏–Ω–≥ / —Å—Ç–∞—Ä—Ç
# =========================
def render_onboarding(
    first_name: str,
    is_new: bool,
    plan_title: str,
    mode_title: str,
) -> str:
    if is_new:
        prefix = f"–ü—Ä–∏–≤–µ—Ç, *{first_name}* üëã\n\n"
        middle = "–Ø ‚Äî *Black Box GPT*, —Ç–≤–æ–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n\n"
    else:
        prefix = f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, *{first_name}* üîÅ\n\n"
        middle = "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É.\n\n"

    return (
        prefix
        + middle
        + f"*–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ:* `{plan_title}`\n"
        + f"*–†–µ–∂–∏–º:* `{mode_title}`\n\n"
        + "üëá –ò—Å–ø–æ–ª—å–∑—É–π –Ω–∏–∂–Ω–∏–π —Ç–∞—Å–∫–±–∞—Ä, —á—Ç–æ–±—ã:\n"
        + "‚Ä¢ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Ä–µ–∂–∏–º—ã\n"
        + "‚Ä¢ —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ –ª–∏–º–∏—Ç—ã\n"
        + "‚Ä¢ –æ—Ñ–æ—Ä–º–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏\n\n"
        + "–ê –º–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –æ—Ç –º–µ–¥–∏—Ü–∏–Ω—ã –∏ –±–∏–∑–Ω–µ—Å–∞ "
          "–¥–æ –ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –∏ –∫—Ä–µ–∞—Ç–∏–≤–∞."
    )


# =========================
#  –ü—Ä–æ—Ñ–∏–ª—å
# =========================
def render_profile(
    plan_code: str,
    plan_title: str,
    is_admin: bool,
    daily_used: int,
    monthly_used: int,
    premium_until: Optional[datetime],
    total_requests: int,
    total_tokens: int,
    ref_code: Optional[str],
) -> str:
    if is_admin or plan_code == "admin":
        daily_max = "–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
        monthly_max = "–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
    elif plan_code == "premium":
        daily_max = f"{PREMIUM_DAILY_LIMIT} / –¥–µ–Ω—å"
        monthly_max = f"{PREMIUM_MONTHLY_LIMIT} / –º–µ—Å—è—Ü"
    else:
        daily_max = f"{FREE_DAILY_LIMIT} / –¥–µ–Ω—å"
        monthly_max = f"{FREE_MONTHLY_LIMIT} / –º–µ—Å—è—Ü"

    premium_str = (
        "–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ " + _fmt_date(premium_until)
        if premium_until
        else "–Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"
    )

    ref_str = ref_code or "–µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

    return (
        "üë§ *–ü—Ä–æ—Ñ–∏–ª—å*\n\n"
        f"*–¢–∞—Ä–∏—Ñ:* `{plan_title}`\n"
        f"*–ü—Ä–µ–º–∏—É–º:* {premium_str}\n"
        f"*–ê–¥–º–∏–Ω:* {'–¥–∞' if is_admin else '–Ω–µ—Ç'}\n\n"
        "*–õ–∏–º–∏—Ç—ã:*\n"
        f"‚Ä¢ –î–Ω–µ–≤–Ω–æ–π: {daily_max}\n"
        f"‚Ä¢ –ú–µ—Å—è—á–Ω—ã–π: {monthly_max}\n\n"
        "*–¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:*\n"
        f"‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –¥–µ–Ω—å: {daily_used}\n"
        f"‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –º–µ—Å—è—Ü: {monthly_used}\n"
        f"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {_humanize_int(total_requests)}\n"
        f"‚Ä¢ –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: {_humanize_int(total_tokens)}\n\n"
        "*–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:*\n"
        f"`{ref_str}`\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤ —Ä–∞–∑–¥–µ–ª–µ *¬´–†–µ—Ñ–µ—Ä–∞–ª—ã¬ª*, "
        "—á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã –∑–∞ –¥—Ä—É–∑–µ–π."
    )


# =========================
#  –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–æ–≤
# =========================
def render_modes_root() -> str:
    return (
        "üß† *–†–µ–∂–∏–º—ã Black Box GPT*\n\n"
        "–í—ã–±–µ—Ä–∏, –≤ –∫–∞–∫–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —è –±—É–¥—É –º—ã—Å–ª–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:\n\n"
        "‚Ä¢ *–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π* ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤—Å—ë –ø–æ–¥—Ä—è–¥: –±—ã—Ç, –∏–¥–µ–∏, —Ç–µ–∫—Å—Ç—ã, –∫–æ–¥.\n"
        "‚Ä¢ *–ú–µ–¥–∏—Ü–∏–Ω–∞* ‚Äî –ø–æ–º–æ—â—å –≤—Ä–∞—á—É: —Ä–∞–∑–±–æ—Ä —Å–ª—É—á–∞–µ–≤, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã, —Å—Ç–∞—Ç—å–∏.\n"
        "‚Ä¢ *–ù–∞—Å—Ç–∞–≤–Ω–∏–∫* ‚Äî —Ä–∞–∑–≤–∏—Ç–∏–µ, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, –º—ã—à–ª–µ–Ω–∏–µ, –ª–∏—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä.\n"
        "‚Ä¢ *–ë–∏–∑–Ω–µ—Å* ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –≤–æ—Ä–æ–Ω–∫–∏, –ø—Ä–æ–¥—É–∫—Ç, –¥–µ–Ω—å–≥–∏, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.\n"
        "‚Ä¢ *–ö—Ä–µ–∞—Ç–∏–≤* ‚Äî –¥–∏–∑–∞–π–Ω-–∏–¥–µ–∏, –ø—Ä–æ–º–ø—Ç—ã, –æ–±—Ä–∞–∑, –≤–∏–∑—É–∞–ª, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏.\n\n"
        "–†–µ–∂–∏–º –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è –∏ —É–≥–æ–ª –∑—Ä–µ–Ω–∏—è.\n"
        "–¢–µ–º—É –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –ª—é–±—É—é ‚Äî –¥–∞–∂–µ –≤–Ω–µ —Ä–µ–∂–∏–º–∞.\n\n"
        "üëá –ù–∞–∂–º–∏ –Ω–∞ –Ω—É–∂–Ω—ã–π —Ä–µ–∂–∏–º –≤ —Ç–∞—Å–∫–±–∞—Ä–µ –Ω–∏–∂–µ."
    )


def render_mode_switched(mode_title: str) -> str:
    return (
        f"‚úÖ –†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ *{mode_title}*.\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥—É—Ç —Å—Ç—Ä–æ–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.\n"
        "–ú–æ–∂–µ—à—å —Å—Ä–∞–∑—É –ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å."
    )


# =========================
#  –ü–æ–¥–ø–∏—Å–∫–∞ / –æ–ø–ª–∞—Ç–∞
# =========================
def render_subscription_overview(
    plan_title: str,
    premium_until: Optional[datetime],
) -> str:
    has_premium = premium_until is not None

    base_limits = (
        f"{FREE_DAILY_LIMIT} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å / "
        f"{FREE_MONTHLY_LIMIT} –≤ –º–µ—Å—è—Ü"
    )
    premium_limits = (
        f"{PREMIUM_DAILY_LIMIT} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å / "
        f"{PREMIUM_MONTHLY_LIMIT} –≤ –º–µ—Å—è—Ü"
    )

    if has_premium:
        premium_str = (
            f"–ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–µ–Ω –¥–æ *{_fmt_date(premium_until)}* ‚úÖ\n\n"
        )
    else:
        premium_str = "–£ —Ç–µ–±—è —Å–µ–π—á–∞—Å –±–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ.\n\n"

    return (
        "üíé *–ü–æ–¥–ø–∏—Å–∫–∞ Black Box GPT*\n\n"
        f"*–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ:* `{plan_title}`\n"
        + premium_str
        + "*–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞:*\n"
        f"‚Ä¢ {base_limits}\n\n"
        "*–ß—Ç–æ –¥–∞—ë—Ç Premium:*\n"
        f"‚Ä¢ –õ–∏–º–∏—Ç—ã: {premium_limits}\n"
        "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞\n"
        "‚Ä¢ –ë–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã\n\n"
        "üëá –í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É."
    )


def render_payment_link(
    tariff_title: str,
    amount: float,
    invoice_url: str,
) -> str:
    return (
        "üí≥ *–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏*\n\n"
        f"–¢–∞—Ä–∏—Ñ: *{tariff_title}*\n"
        f"–°—É–º–º–∞: *{amount} USDT*\n\n"
        "1Ô∏è‚É£ –ü–µ—Ä–µ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—Ç–∏ —Å—á—ë—Ç –≤ Cryptobot.\n"
        "2Ô∏è‚É£ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Å—å –≤ –±–æ—Ç–∞.\n"
        "3Ô∏è‚É£ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É *¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª*.\n\n"
        f"üîó [–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É]({invoice_url})"
    )


def render_payment_error() -> str:
    return (
        "‚ùå *–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞*\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ.\n"
        "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
    )


def render_payment_check_result(status: str) -> str:
    if status == "paid":
        return (
            "‚úÖ *–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞*\n\n"
            "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ –ø—Ä–æ–¥–ª–µ–Ω–∞.\n"
            "–ú–æ–∂–µ—à—å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É."
        )
    if status == "pending":
        return (
            "‚åõ *–ü–ª–∞—Ç—ë–∂ –µ—â—ë –≤ –æ–∂–∏–¥–∞–Ω–∏–∏*\n\n"
            "–°–∏—Å—Ç–µ–º–∞ Cryptobot –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∞ –æ–ø–ª–∞—Ç—É.\n"
            "–ü–æ–ø—Ä–æ–±—É–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 10‚Äì30 —Å–µ–∫—É–Ω–¥."
        )
    if status == "not_found":
        return (
            "‚ùì *–°—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω*\n\n"
            "–Ø –Ω–µ –≤–∏–∂—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—á—ë—Ç–∞ –æ–ø–ª–∞—Ç—ã.\n"
            "–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª *¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª*."
        )

    # –õ—é–±–æ–π –¥—Ä—É–≥–æ–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    return (
        "‚ö†Ô∏è *–ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã*\n\n"
        f"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å: `{status}`.\n"
        "–ï—Å–ª–∏ —Ç—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ ‚Äî –Ω–∞–ø–∏—à–∏ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
    )


# =========================
#  –†–µ—Ñ–µ—Ä–∞–ª—ã
# =========================
def render_referrals(
    ref_link: str,
    total_refs: int,
) -> str:
    return (
        "üë• *–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞*\n\n"
        "–ü–æ–∑–æ–≤–∏ –¥—Ä—É–∑–µ–π –≤ Black Box GPT –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã.\n\n"
        "*–¢–≤–æ—è –ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞:*\n"
        f"{ref_link}\n\n"
        f"*–£–∂–µ –ø—Ä–∏—à–ª–æ –ø–æ —Å—Å—ã–ª–∫–µ:* {_humanize_int(total_refs)} —á–µ–ª.\n\n"
        "–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å —Ç–µ–º, –∫–æ–º—É –Ω—É–∂–µ–Ω —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n"
        "–û–Ω–∏ —Å—Ç–∞—Ä—Ç—É—é—Ç –≤ –±–æ—Ç–µ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –≤—Å—ë —É—á—Ç—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
    )


# =========================
#  –û—à–∏–±–∫–∏ / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
# =========================
def render_generic_error() -> str:
    return (
        "‚ö†Ô∏è *–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫*\n\n"
        "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.\n"
        "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
    )


def render_empty_prompt_error() -> str:
    return (
        "ü§î –ü–æ—Ö–æ–∂–µ, —Ç—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n\n"
        "–ù–∞–ø–∏—à–∏ —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∑–∞–¥–∞—á—É –∏–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞."
    )


def render_too_long_prompt_error() -> str:
    return (
        "üìè *–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –∑–∞–ø—Ä–æ—Å*\n\n"
        "–Ø –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫–æ–π –æ–±—ä—ë–º —Ç–µ–∫—Å—Ç–∞ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑.\n"
        "–°–æ–∫—Ä–∞—Ç–∏ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ä–∞–∑–±–µ–π –µ–≥–æ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π."
    )


def render_limits_warning(reason: str) -> str:
    return (
        "‚õî *–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω*\n\n"
        f"{reason}\n\n"
        "–û—Ñ–æ—Ä–º–∏ *Premium* –≤ —Ä–∞–∑–¥–µ–ª–µ *¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª*, "
        "—á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª—å—à–µ –æ—Ç–≤–µ—Ç–æ–≤."
    )
