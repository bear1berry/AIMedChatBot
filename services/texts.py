from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime
from typing import Optional

from bot.config import (
    FREE_DAILY_LIMIT,
    FREE_MONTHLY_LIMIT,
    PREMIUM_DAILY_LIMIT,
    PREMIUM_MONTHLY_LIMIT,
    REF_BASE_URL,
)


@dataclass
class PlanInfo:
    code: str
    title: str
    daily_limit: int
    monthly_limit: int


def _fmt_date(ts: Optional[float]) -> str:
    if not ts:
        return "‚Äî"
    return datetime.fromtimestamp(ts).strftime("%d.%m.%Y")


def render_onboarding(
    first_name: str | None,
    is_new: bool,
    plan_title: str,
    mode_title: str,
) -> str:
    name = first_name or "–¥—Ä—É–≥"
    status_line = (
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ BlackBox GPT."
        if is_new
        else "–†–∞–¥ —Å–Ω–æ–≤–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å –≤–Ω—É—Ç—Ä–∏ BlackBox GPT."
    )

    return (
        f"üëã –ü—Ä–∏–≤–µ—Ç, *{name}*.\n\n"
        f"{status_line}\n\n"
        f"üß† *–†–µ–∂–∏–º —Å–µ–π—á–∞—Å*: _{mode_title}_\n"
        f"üíé *–¢–∞—Ä–∏—Ñ*: _{plan_title}_\n\n"
        "–ù–∞–ø–∏—à–∏ –º–Ω–µ –ª—é–±–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–æ—Å—Ç–∞ –∏–ª–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞.\n\n"
        "–Ø –æ—Ç–≤–µ—á–∞—é –∞–∫–∫—É—Ä–∞—Ç–Ω–æ: –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞, —Å —á–∏—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ —Ç–≤–æ–µ–º—É –≤—Ä–µ–º–µ–Ω–∏."
    )


def render_profile(
    plan_code: str,
    plan_title: str,
    is_admin: bool,
    daily_used: int,
    monthly_used: int,
    premium_until: Optional[float],
    total_requests: int,
    total_tokens: int,
    ref_code: str | None,
) -> str:
    if is_admin or plan_code == "admin":
        plan_line = "üíé *–¢–∞—Ä–∏—Ñ*: `ADMIN` ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
        daily_limits = "‚àû"
        monthly_limits = "‚àû"
    else:
        plan_line = f"üíé *–¢–∞—Ä–∏—Ñ*: _{plan_title}_"
        if plan_code == "premium":
            daily_max = PREMIUM_DAILY_LIMIT
            monthly_max = PREMIUM_MONTHLY_LIMIT
        else:
            daily_max = FREE_DAILY_LIMIT
            monthly_max = FREE_MONTHLY_LIMIT

        daily_limits = f"{daily_used} / {daily_max}"
        monthly_limits = f"{monthly_used} / {monthly_max}"

    ref_line = ""
    if ref_code:
        link = f"{REF_BASE_URL}?start=ref_{ref_code}"
        ref_line = f"\n\nüîó *–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:*\n`{link}`"

    return (
        "üë§ *–ü—Ä–æ—Ñ–∏–ª—å*\n\n"
        f"{plan_line}\n"
        f"üìÖ *–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç*: {daily_limits}\n"
        f"üìÜ *–ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç*: {monthly_limits}\n"
        f"‚è≥ *Premium –¥–æ*: {_fmt_date(premium_until)}\n\n"
        f"üìä *–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤*: {total_requests}\n"
        f"üî¢ *–ü—Ä–∏–º–µ—Ä–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ*: {total_tokens}"
        f"{ref_line}"
    )


def render_limits_warning(reason: str) -> str:
    return (
        "‚ö†Ô∏è *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é*\n\n"
        f"{reason}\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ.\n\n"
        "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ‚Äî –ø–æ–¥–∫–ª—é—á–∏ —Ç–∞—Ä–∏—Ñ *Premium* –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª."
    )


def render_empty_prompt_error() -> str:
    return (
        "–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—Ä–æ—Å.\n\n"
        "–ú–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é, –ø–æ–º–æ—á—å —Å —Ä–µ—à–µ–Ω–∏–µ–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª–∏ "
        "–∏–ª–∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç."
    )


def render_too_long_prompt_error() -> str:
    return (
        "–ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∏–ª—Å—è —Å–ª–∏—à–∫–æ–º –æ–±—ä—ë–º–Ω—ã–º.\n\n"
        "–°–æ–∫—Ä–∞—Ç–∏ –µ–≥–æ –∏–ª–∏ —Ä–∞–∑–±–µ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π ‚Äî "
        "—Ç–∞–∫ —è —Å–º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ—á–Ω–µ–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ."
    )


def render_modes_root() -> str:
    return (
        "üß† *–†–µ–∂–∏–º—ã BlackBox GPT*\n\n"
        "–ö–∞–∂–¥—ã–π —Ä–µ–∂–∏–º ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –º–æ–∑–≥, –Ω–æ —Å —Ä–∞–∑–Ω–æ–π —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–æ–π:\n"
        "‚Ä¢ *–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç* ‚Äî –±–∞–ª–∞–Ω—Å –ª–æ–≥–∏–∫–∏, —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∫—Ä–µ–∞—Ç–∏–≤–∞.\n"
        "‚Ä¢ *–ú–µ–¥–∏—Ü–∏–Ω–∞* ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –æ–ø–æ—Ä–æ–π –Ω–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—É—é –±–∞–∑—É.\n"
        "‚Ä¢ *–ù–∞—Å—Ç–∞–≤–Ω–∏–∫* ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –ø—Ä–æ–∫–∞—á–∫–∞ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –º—ã—à–ª–µ–Ω–∏—è.\n"
        "‚Ä¢ *–ë–∏–∑–Ω–µ—Å* ‚Äî –∏–¥–µ–∏ –¥–ª—è —Ä–æ—Å—Ç–∞, –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç–µ–∫—Å—Ç—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–¥–∞—á.\n"
        "‚Ä¢ *–ö—Ä–µ–∞—Ç–∏–≤* ‚Äî –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã.\n\n"
        "–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ ‚Äî —è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ—é —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–¥ –∑–∞–¥–∞—á—É.\n"
        "–í –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å *–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π* —Ä–µ–∂–∏–º."
    )


def render_mode_switched(mode_title: str) -> str:
    return (
        "üß† *–†–µ–∂–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω*\n\n"
        f"–¢–µ–ø–µ—Ä—å —è —Ä–∞–±–æ—Ç–∞—é –≤ —Ä–µ–∂–∏–º–µ: _{mode_title}_\n\n"
        "–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ–¥—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–¥ –Ω–µ–≥–æ, "
        "–∞ –≤–Ω—É—Ç—Ä–∏ ‚Äî –≤—Å—ë —Ç–æ –∂–µ –º–æ—â–Ω–æ–µ —è–¥—Ä–æ BlackBox GPT."
    )


def render_subscription_overview(
    plan_title: str,
    premium_until: Optional[float],
) -> str:
    base = (
        "üíé *–ü–æ–¥–ø–∏—Å–∫–∞ BlackBox GPT*\n\n"
        "–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –¥–≤–∞ —É—Ä–æ–≤–Ω—è:\n"
        "‚Ä¢ _–ë–∞–∑–æ–≤—ã–π_ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞ –¥–µ–Ω—å –∏ –º–µ—Å—è—Ü.\n"
        "‚Ä¢ _Premium_ ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –æ—Ç–∫–ª–∏–∫.\n\n"
    )

    current = f"–¢–≤–æ–π —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: *{plan_title}*.\n"
    if plan_title == "Premium":
        current += f"Premium –∞–∫—Ç–∏–≤–µ–Ω –¥–æ: *{_fmt_date(premium_until)}*.\n\n"
    else:
        current += "\n"

    tail = (
        "–í—ã–±–µ—Ä–∏ —Å—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–Ω–∏–∑—É ‚Äî —è –æ—Ç–∫—Ä–æ—é –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã –≤ CryptoBot (USDT).\n"
        "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏—Å—å –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª."
    )

    return base + current + tail


def render_payment_link(
    tariff_title: str,
    amount: str,
    invoice_url: str,
) -> str:
    return (
        "‚úÖ *–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω*\n\n"
        f"–¢–∞—Ä–∏—Ñ: *{tariff_title}*\n"
        f"–°—É–º–º–∞: *{amount} USDT*\n\n"
        f"–ü–µ—Ä–µ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ CryptoBot:\n{invoice_url}\n\n"
        "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Å—å –≤ –±–æ—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª "
        "–≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª."
    )


def render_payment_error() -> str:
    return (
        "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç –≤ CryptoBot.\n\n"
        "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –±–æ—Ç @CryptoBot –¥–æ—Å—Ç—É–ø–µ–Ω, –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
    )


def render_payment_check_result(status: str) -> str:
    if status == "paid":
        return (
            "‚úÖ *–û–ø–ª–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞*\n\n"
            "–ü–æ–¥–ø–∏—Å–∫–∞ *Premium* –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.\n"
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ ‚Äî —Ç–µ–ø–µ—Ä—å –ª–∏–º–∏—Ç—ã —Ä–∞—Å—à–∏—Ä–µ–Ω—ã, "
            "–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–º –º–æ—â–Ω–æ—Å—Ç—è–º –ø–æ–≤—ã—à–µ–Ω."
        )
    elif status == "active":
        return (
            "–°—á—ë—Ç –µ—â—ë –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã.\n\n"
            "–ó–∞–≤–µ—Ä—à–∏ –æ–ø–ª–∞—Ç—É –≤ CryptoBot –∏ –ø–æ–ø—Ä–æ–±—É–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
        )
    elif status == "not_found":
        return (
            "–Ø –Ω–µ –Ω–∞—à—ë–ª –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.\n\n"
            "–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Å—á—ë—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª "
            "–∏ –∑–∞—Ç–µ–º —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª."
        )
    else:
        return (
            "‚ö†Ô∏è –°—á—ë—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ "
            f"(—Å—Ç–∞—Ç—É—Å: `{status}`).\n\n"
            "–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Å—á—ë—Ç –∏ –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–ø—ã—Ç–∫—É."
        )


def render_referrals(ref_link: str, total_refs: int) -> str:
    return (
        "ü§ù *–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞*\n\n"
        "–ü–æ–¥–µ–ª–∏—Å—å –±–æ—Ç–æ–º —Å —Ç–µ–º–∏, –∫–æ–º—É –æ–Ω —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω. "
        "–ù–∏–∫–∞–∫–æ–≥–æ —Å–ø–∞–º–∞ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.\n\n"
        f"üîó *–¢–≤–æ—è —Å—Å—ã–ª–∫–∞:*\n`{ref_link}`\n\n"
        f"–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: *{total_refs}* —á–µ–ª–æ–≤–µ–∫(–∞).\n\n"
        "–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É —Ç–µ–º, –∫–æ–º—É —Ö–æ—á–µ—à—å –ø—Ä–æ–∫–∞—á–∞—Ç—å –º–æ–∑–≥ –∏ —Å–∏—Å—Ç–µ–º—É."
    )


def render_generic_error() -> str:
    return (
        "‚ö†Ô∏è –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –Ω–∞ –º–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ.\n\n"
        "–Ø —É–∂–µ –ø—Ä–∏–≤—ë–ª –º—ã—Å–ª–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —Ç–µ–º –∂–µ –∑–∞–ø—Ä–æ—Å–æ–º. "
        "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –Ω–∞–ø–∏—à–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—é –±–æ—Ç–∞."
    )
