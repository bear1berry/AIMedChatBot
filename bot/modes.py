# bot/modes.py

import re

# -----------------------------------------------------------
#  Ð¡Ð›ÐžÐ’ÐÐ Ð¬ Ð Ð•Ð–Ð˜ÐœÐžÐ’
# -----------------------------------------------------------

MODES = {
    "default": {
        "name": "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹",
        "emoji": "ðŸ’¬",
        "prompt": "Ð’Ñ‹ â€” Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ€Ð°Ñ‡-Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ ÑÑÐ½Ð¾, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾."
    },

    "simple": {
        "name": "ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸",
        "emoji": "ðŸ§ ",
        "prompt": "ÐžÐ±ÑŠÑÑÐ½ÑÐ¹Ñ‚Ðµ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼, ÐºÐ°Ðº Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ Ð±ÐµÐ· Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¾Ð³Ð¾ Ð¾Ð¿Ñ‹Ñ‚Ð°."
    },

    "medical": {
        "name": "ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ð¹ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº",
        "emoji": "ðŸ“š",
        "prompt": "Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ñ‡Ñ‘Ñ‚ÐºÑƒÑŽ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ, ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸, Ð´Ð¾Ð·Ð¸Ñ€Ð¾Ð²ÐºÐ¸, ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ñ‹."
    },

    "symptoms": {
        "name": "ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ð¾Ð²",
        "emoji": "ðŸ”",
        "prompt": "Ð’Ñ‹ Ð²Ñ€Ð°Ñ‡-Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚. ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ñ‹, Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹Ñ‚Ðµ Ð´Ð¸Ñ„Ñ„ÐµÑ€ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð´Ð¸Ð°Ð³Ð½Ð¾Ð·."
    },

    # ========== ÐÐ¾Ð²Ñ‹Ðµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ñ€ÐµÐ¶Ð¸Ð¼Ñ‹ ==========
    "pediatrics": {
        "name": "ÐŸÐµÐ´Ð¸Ð°Ñ‚Ñ€Ð¸Ñ",
        "emoji": "ðŸ§’",
        "prompt": "Ð’Ñ‹ â€” Ð´ÐµÑ‚ÑÐºÐ¸Ð¹ Ð²Ñ€Ð°Ñ‡. Ð”Ð°Ñ‘Ñ‚Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð´ÐµÑ‚ÐµÐ¹ Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°."
    },

    "dermatology": {
        "name": "Ð”ÐµÑ€Ð¼Ð°Ñ‚Ð¾Ð»Ð¾Ð³Ð¸Ñ",
        "emoji": "ðŸ©¹",
        "prompt": "Ð’Ñ‹ â€” Ð´ÐµÑ€Ð¼Ð°Ñ‚Ð¾Ð»Ð¾Ð³. ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¶Ñƒ, ÑÑ‹Ð¿Ð¸, Ð¿Ð¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ, Ð·Ð°Ð±Ð¾Ð»ÐµÐ²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¶Ð¸."
    },

    "ophthalmology": {
        "name": "ÐžÑ„Ñ‚Ð°Ð»ÑŒÐ¼Ð¾Ð»Ð¾Ð³Ð¸Ñ",
        "emoji": "ðŸ‘ï¸",
        "prompt": "Ð’Ñ‹ â€” Ð¾Ñ„Ñ‚Ð°Ð»ÑŒÐ¼Ð¾Ð»Ð¾Ð³. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ… Ð·Ñ€ÐµÐ½Ð¸Ñ, Ð³Ð»Ð°Ð·, Ñ‚Ñ€Ð°Ð²Ð¼Ð°Ñ…, Ð¸Ð½Ñ„ÐµÐºÑ†Ð¸ÑÑ…."
    },

    "gynecology": {
        "name": "Ð“Ð¸Ð½ÐµÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ",
        "emoji": "ðŸŒ¸",
        "prompt": "Ð’Ñ‹ â€” Ð²Ñ€Ð°Ñ‡-Ð³Ð¸Ð½ÐµÐºÐ¾Ð»Ð¾Ð³. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾, Ð´ÐµÐ»Ð¸ÐºÐ°Ñ‚Ð½Ð¾."
    },

    "cardiology": {
        "name": "ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ",
        "emoji": "â¤ï¸â€ðŸ”¥",
        "prompt": "Ð’Ñ‹ â€” ÐºÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³. ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ñ‹, Ð§Ð¡Ð¡, Ð­ÐšÐ“, Ñ€Ð¸ÑÐºÐ¸."
    },

    "neurology": {
        "name": "ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
        "emoji": "ðŸ§ âš¡",
        "prompt": "Ð’Ñ‹ â€” Ð½ÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¾ Ð±Ð¾Ð»Ð¸, Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸ÑÑ… Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸, Ð½ÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ð°Ñ…."
    },
}


# ------------------------------------------------------------------
#  Ð¡Ð±Ð¾Ñ€ÐºÐ° system prompt
# ------------------------------------------------------------------
def build_system_prompt(mode: str) -> str:
    mode = mode.lower()
    if mode not in MODES:
        mode = "default"

    data = MODES[mode]

    return (
        f"{data['prompt']}\n"
        f"ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾. "
        f"Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð½Ðµ Ð¿Ð¾ Ñ‚ÐµÐ¼Ðµ Ñ€ÐµÐ¶Ð¸Ð¼Ð° â€” Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¾Ñ‚Ð²ÐµÑ‚."
    )


# ------------------------------------------------------------------
#  ÐÐ²Ñ‚Ð¾-Ð´ÐµÑ‚ÐµÐºÑ‚ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð¿Ð¾ Ñ‚ÐµÐºÑÑ‚Ñƒ
# ------------------------------------------------------------------
DETECT_PATTERNS = {
    "pediatrics": [
        r"Ñ€ÐµÐ±ÐµÐ½(Ð¾Ðº|ÐºÑƒ|ÐºÐ°)", r"Ð´ÐµÑ‚Ðµ[Ð¹Ð¼]", r"Ð¼Ð»Ð°Ð´ÐµÐ½", r"Ð³Ñ€ÑƒÐ´Ð½Ð¸Ñ‡", r"Ð½Ð¾Ð²Ð¾Ñ€Ð¾Ð¶Ð´ÐµÐ½"
    ],
    "dermatology": [
        r"ÑÑ‹Ð¿", r"ÐºÐ¾Ð¶", r"Ð²Ð¾Ð»Ð´Ñ‹Ñ€", r"Ð¿ÑÑ‚Ð½", r"ÑˆÐµÐ»ÑƒÑˆ", r"Ð²Ñ‹ÑÑ‹Ð¿"
    ],
    "ophthalmology": [
        r"Ð³Ð»Ð°Ð·", r"Ð·Ñ€ÐµÐ½Ð¸Ðµ", r"Ð¿Ð¾ÐºÑ€Ð°ÑÐ½ÐµÐ½Ð¸", r"ÐºÐ¾Ð½ÑŠÑŽÐ½ÐºÑ‚Ð¸Ð²", r"Ñ‡ÐµÑˆÐµÑ‚(ÑÑ)? Ð³Ð»Ð°Ð·"
    ],
    "gynecology": [
        r"Ð¼ÐµÑÑÑ‡Ð½", r"Ñ†Ð¸ÐºÐ»", r"Ð³Ð¸Ð½ÐµÐºÐ¾Ð»Ð¾Ð³", r"Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½", r"Ð±ÐµÑ€ÐµÐ¼ÐµÐ½"
    ],
    "cardiology": [
        r"ÑÐµÑ€Ð´Ñ†", r"Ð´Ð°Ð²Ð»ÐµÐ½Ð¸", r"ÑÐºÐ³", r"Ð¿ÑƒÐ»ÑŒÑ", r"Ñ‚Ð°Ñ…Ð¸ÐºÐ°Ñ€Ð´", r"Ð°Ñ€Ð¸Ñ‚Ð¼Ð¸"
    ],
    "neurology": [
        r"Ð³Ð¾Ð»Ð¾Ð²Ð½(Ð°Ñ )?Ð±Ð¾Ð»ÑŒ", r"Ð½ÐµÐ²Ñ€Ð°Ð»Ð³", r"Ð¾Ð½ÐµÐ¼ÐµÐ½Ð¸", r"Ð³Ð¾Ð»Ð¾Ð²Ð¾ÐºÑ€ÑƒÐ¶", r"ÑÑƒÐ´Ð¾Ñ€Ð¾Ð³"
    ],
    "symptoms": [
        r"Ð±Ð¾Ð»Ð¸Ñ‚", r"Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€", r"ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼", r"Ñ‚Ð¾ÑˆÐ½Ð¸Ñ‚", r"ÐºÐ°ÑˆÐ»Ñ", r"Ð¿Ñ€Ð¾ÑÑ‚ÑƒÐ´"
    ]
}


def auto_detect_mode(text: str) -> str:
    text = text.lower()

    for mode, patterns in DETECT_PATTERNS.items():
        for p in patterns:
            if re.search(p, text):
                return mode

    return "default"
