from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import CommandStart, Command

from .ai_client import ask_ai

router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message):
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ –∫–∞–Ω–∞–ª–∞ AI.Medicine üß¨\n\n"
        "–Ø –º–æ–≥—É:\n"
        "‚Ä¢ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º –æ–±—ä—è—Å–Ω—è—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã;\n"
        "‚Ä¢ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ–± –æ–±—â–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –ª–µ—á–µ–Ω–∏—è;\n"
        "‚Ä¢ –ø–æ–º–æ–≥–∞—Ç—å —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —Ç–µ–º–∞—Ö –∏–∑ –ø–æ—Å—Ç–æ–≤ –∫–∞–Ω–∞–ª–∞.\n\n"
        "–í–∞–∂–Ω–æ: —è –Ω–µ —Å—Ç–∞–≤–ª—é –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞—é –ª–µ—á–µ–Ω–∏–µ. "
        "–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –∑–¥–æ—Ä–æ–≤—å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É –æ—á–Ω–æ.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å üëá"
    )
    await message.answer(text)


@router.message(Command("help"))
async def cmd_help(message: Message):
    text = (
        "–≠—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ç–µ–º–∞—Ç–∏–∫–µ.\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:\n"
        "‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏?\n"
        "‚Ä¢ –ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –û–†–í–ò –æ—Ç –≥—Ä–∏–ø–ø–∞?\n"
        "‚Ä¢ –ß—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–∏–∞–≥–Ω–æ–∑ –≤ —ç—Ç–æ–º –∞–Ω–∞–ª–∏–∑–µ?\n\n"
        "‚ùóÔ∏è–û—Ç–≤–µ—Ç—ã –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞."
    )
    await message.answer(text)


@router.message(F.text)
async def handle_text(message: Message):
    user_text = message.text.strip()

    if not user_text:
        await message.answer("–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.")
        return

    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
    if len(user_text) < 5:
        await message.answer("–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å —á—É—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ üôè")
        return

    waiting_text = "–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º‚Ä¶ 1‚Äì2 —Å–µ–∫—É–Ω–¥—ã üß†"
    await message.answer(waiting_text)

    try:
        ai_answer = await ask_ai(user_text)
    except Exception as e:
        # –ú–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å e
        await message.answer(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
        )
        return

    await message.answer(ai_answer)
